<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roomba Rover</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/pcm-player.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nipplejs@0.9.0/dist/nipplejs.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            font-family: system-ui, sans-serif;
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-900">
    <div class="flex flex-col lg:flex-row p-4 gap-6">
        <div class="flex-1 space-y-4">
            <div class="rounded-xl bg-white shadow-md p-4">
                <p class="text-lg font-semibold">Live Video Feed</p>
                <img id="video" class="w-full max-w-full rounded-md" />
                <div class="flex gap-2 mt-2">
                    <button onclick="startVideo()" class="btn">Start Video</button>
                    <button onclick="stopVideo()" class="btn">Stop Video</button>
                </div>
            </div>

            <div class="rounded-xl bg-white shadow-md p-4 h-48" id="joystick">
                <h2 class="text-xl font-bold mb-2">Mobile Joystick</h2>
                <!-- <div id="joystick" class="h-48 w-48 mx-auto"></div> -->
            </div>

            <div class="rounded-xl bg-white shadow-md p-4">
                <p class="text-lg font-semibold">Audio Controls</p>
                <div class="flex gap-2 mt-2">
                    <button onclick="startAudio()" class="btn">Start Audio</button>
                    <button onclick="stopAudio()" class="btn">Stop Audio</button>
                </div>
            </div>

            <div class="rounded-xl bg-white shadow-md p-4">
                <p class="text-lg font-semibold">Sensor Controls</p>
                <div class="flex flex-wrap gap-2 mt-2">
                    <button onclick="sensorData()" class="btn">Fetch Sensor Data</button>
                    <button onclick="dockNow()" class="btn">Dock</button>
                    <button onclick="reconnectRoomba()" class="btn">Reconnect</button>
                </div>
            </div>

            <div class="rounded-xl bg-white shadow-md p-4">
                <p class="text-lg font-semibold">Keyboard Control</p>
                <p>Use <strong>W, A, S, D</strong> to drive. Hold <strong>Shift</strong> for slow, <strong>Enter</strong> for fast.</p>
            </div>
        </div>

        <div class="flex-1 space-y-4">
            <div class="rounded-xl bg-white shadow-md p-4">
                <h2 class="text-xl font-bold mb-2">Sensor Data</h2>
                <p id="charge-status"></p>
                <p id="battery-usage"></p>
                <p id="charging-sources"></p>
                <p id="oi-mode"></p>
                <p id="dock-status"></p>
                <p id="battery-voltage"></p>
            </div>



            <div class="rounded-xl bg-white shadow-md p-4">
                <p class="font-medium text-blue-600" id="message"></p>
            </div>
        </div>
    </div>

    <script>
        var socket = io()
        const player = new PCMPlayer({
            encoding: '16bitInt',
            channels: 1,
            sampleRate: 16000,
            flushTime: 20
        });

        socket.on('connect', () => console.log('Connected to server'));
        socket.on('disconnect', () => console.log('Disconnected from server'));

        const pressedKeys = new Set();

        function handleKeyEvent(event, isKeyDown) {
            const key = event.key.toLowerCase();
            if (['w', 'a', 's', 'd', 'shift', 'enter'].includes(key)) {
                if (isKeyDown && !pressedKeys.has(key)) pressedKeys.add(key);
                else if (!isKeyDown) pressedKeys.delete(key);
                else return;

                const speeds = keySpeedCalculator(pressedKeys);
                socket.emit('Speedchange', speeds);
            }
        }

        document.addEventListener('keydown', e => handleKeyEvent(e, true));
        document.addEventListener('keyup', e => handleKeyEvent(e, false));

        function keySpeedCalculator(keys) {
            const baseSpeed = 100;
            const fast = 2.5, slow = 0.5;
            let left = 0, right = 0, mult = 1;
            if (keys.has('enter')) mult = fast;
            else if (keys.has('shift')) mult = slow;
            if (keys.has('w')) left += baseSpeed, right += baseSpeed;
            if (keys.has('s')) left -= baseSpeed, right -= baseSpeed;
            if (keys.has('a')) left -= baseSpeed, right += baseSpeed;
            if (keys.has('d')) left += baseSpeed, right -= baseSpeed;
            return { leftSpeed: left * mult, rightSpeed: right * mult };
        }

        function dockNow() { socket.emit('Docking', { action: 'dock' }); }
        function reconnectRoomba() { socket.emit('Docking', { action: 'reconnect' }); }
        function sensorData() { socket.emit('requestSensorData'); }
        function startVideo() { socket.emit('startVideo'); }
        function stopVideo() { socket.emit('stopVideo'); }
        function startAudio() { socket.emit('startAudio'); }
        function stopAudio() { socket.emit('stopAudio'); }

        socket.on('videoFrame', data => {
            document.getElementById('video').src = 'data:image/jpeg;base64,' + data;
        });

        socket.on('audio', base64 => {
            try {
                const binary = atob(base64);
                const bytes = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
                player.feed(new Int16Array(bytes.buffer));
                player.flush();
            } catch (err) {
                console.error('Error processing audio:', err);
            }
        });

        socket.on('SensorData', data => {
            const chargeStatus = ['Not Charging', 'Reconditioning Charging', 'Full Charging', 'Trickle Charging', 'Waiting', 'Charging Error'][data.chargeStatus] || 'Unknown';
            const chargingSources = data.chargingSources === 2 ? 'Docked' : 'None';
            const oiMode = data.oiMode === 2 ? 'Passive' : (data.oiMode === 4 ? 'Full' : 'Unknown');

            document.getElementById('oi-mode').innerText = `OI Mode: ${oiMode}`;
            document.getElementById('dock-status').innerText = `Dock Status: ${chargingSources}`;
            document.getElementById('charge-status').innerText = `Charging Status: ${chargeStatus}`;
            document.getElementById('battery-usage').innerText = `Battery Charge: ${data.batteryCharge} / ${data.batteryCapacity}`;
            document.getElementById('battery-voltage').innerText = `Battery Voltage: ${data.batteryVoltage / 1000}V`;
        });

        socket.on('message', data => {
            document.getElementById('message').innerText = data;
        });

        // Joystick control
        const joystick = nipplejs.create({
            zone: document.getElementById('joystick'),
            mode: 'dynamic',
            color: 'pink',
            size: '200'
        });

        // wheel speed calculations
        const MAX_SPEED = 400
        joystick.on('move', function (evt, data) {
            if (!data || !data.distance || !data.angle) return;
            let leftSpeed = data.vector.y * MAX_SPEED + data.vector.x * MAX_SPEED;
            let rightSpeed = data.vector.y * MAX_SPEED - data.vector.x * MAX_SPEED;

            leftSpeed = Math.max(-MAX_SPEED, Math.min(MAX_SPEED, leftSpeed));
            rightSpeed = Math.max(-MAX_SPEED, Math.min(MAX_SPEED, rightSpeed));

            leftSpeed = Math.round(leftSpeed);
            rightSpeed = Math.round(rightSpeed);

            // console.log(data.vector.x, data.vector.y);
            console.log(`Left: ${leftSpeed}, Right: ${rightSpeed}`);
            socket.emit('Speedchange', { leftSpeed, rightSpeed });
        });

        joystick.on('end', function () {
            socket.emit('Speedchange', { leftSpeed: 0, rightSpeed: 0 });
        });
    </script>
</body>

</html>
